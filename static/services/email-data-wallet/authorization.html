                    const data = await response.json();
                    const requests = data.success ? data.data : [];
                    displayPendingRequests(requests);
                } else {
                    // API error - show empty state
                    displayPendingRequests([]);
                    showStatus(`API Error: ${response.status}. No pending requests found.`, 'error');
                }

            } catch (error) {
                console.error('‚ùå Error loading pending requests:', error);
                displayPendingRequests([]);
                showStatus('Unable to load pending requests. Please check your connection.', 'error');
            }
        }

        // Display pending requests list - ENHANCED with clean no-data states
        function displayPendingRequests(requests) {
            const pendingList = document.getElementById('pending-list');
            const pendingLoading = document.getElementById('pending-loading');
            
            if (pendingLoading) {
                pendingLoading.style.display = 'none';
            }

            if (!userWallet) {
                pendingList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--gray);">
                        <h3>ü¶ä Connect Your Wallet</h3>
                        <p>Connect your MetaMask wallet to see pending authorization requests for your emails.</p>
                        <p style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="connectOrChangeWallet()">
                                Connect MetaMask
                            </button>
                        </p>
                    </div>
                `;
                return;
            }

            if (!requests || requests.length === 0) {
                pendingList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--gray);">
                        <h3>üì≠ No Pending Requests</h3>
                        <p>You don't have any pending email wallet authorization requests.</p>
                        <p>Send an email to <strong>process@rivetz.com</strong> to create a request.</p>
                        <p style="margin-top: 15px;">
                            <a href="/static/services/email-data-wallet/dashboard.html" class="btn btn-primary">
                                Go to Dashboard
                            </a>
                        </p>
                    </div>
                `;
                return;
            }

            const requestsHTML = requests.map(request => `
                <div class="pending-item">
                    <h4>üìß ${request.emailSubject || 'Email Authorization Request'}</h4>
                    <div style="margin-bottom: 15px;">
                        <strong>From:</strong> ${request.emailSender || 'Unknown sender'}<br>
                        <strong>Attachments:</strong> ${request.attachmentCount || 0}<br>
                        <strong>Cost:</strong> ${request.creditCost || 4} credits<br>
                        <strong>Received:</strong> ${new Date(request.createdAt).toLocaleString()}<br>
                        <strong>Request ID:</strong> <code>${request.requestId}</code>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="authorizeSpecificRequest('${request.requestId}')">
                            Authorize (${request.creditCost || 4} credits)
                        </button>
                        <button class="btn btn-secondary" onclick="rejectSpecificRequest('${request.requestId}')">
                            Reject
                        </button>
                    </div>
                </div>
            `).join('');

            pendingList.innerHTML = `
                <h3 style="margin-bottom: 20px; color: var(--primary);">
                    üìã ${requests.length} Pending Request${requests.length === 1 ? '' : 's'}
                </h3>
                ${requestsHTML}
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="refreshPendingRequests()">
                        üîÑ Refresh List
                    </button>
                </div>
            `;

            showStatus(`Found ${requests.length} pending authorization request${requests.length === 1 ? '' : 's'} for ${userWallet}.`, 'success');
        }

        // Load specific authorization request details - ENHANCED with no default test data
        async function loadAuthorizationRequest() {
            showSingleStatus('Loading authorization request...', 'warning');

            try {
                let apiUrl;
                if (requestId) {
                    apiUrl = `${API_BASE}/authorization/request/${requestId}`;
                    console.log('üîÑ Fetching by request ID:', requestId);
                } else if (authToken) {
                    apiUrl = `${API_BASE}/authorization/token/${authToken}`;
                    console.log('üîÑ Fetching by auth token:', authToken);
                } else {
                    throw new Error('No request ID or auth token provided');
                }

                console.log('üì° API URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('üìä Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ Request data loaded:', data);

                if (data.success && (data.data || data)) {
                    authorizationRequest = data.data || data;
                    displayAuthorizationRequest(authorizationRequest);
                } else {
                    throw new Error(data.error || 'Invalid request data');
                }

            } catch (error) {
                console.error('‚ùå Error loading request via API:', error);
                
                // Show clean error state - no default test data
                showSingleError(`Unable to load authorization request: ${error.message}`);
                
                // Show clean empty state
                document.getElementById('email-from').textContent = '--';
                document.getElementById('email-subject').textContent = '--';
                document.getElementById('request-id').textContent = requestId || '--';
                document.getElementById('auth-token').textContent = authToken || '--';
                
                document.getElementById('email-preview').style.display = 'block';
                document.getElementById('cost-breakdown').style.display = 'block';
                
                // Disable authorization
                document.getElementById('authorize-btn').disabled = true;
            }
        }

        // Display authorization request details - ENHANCED with clean states
        function displayAuthorizationRequest(request) {
            console.log('üìù Displaying request:', request);

            // Show email details
            document.getElementById('email-from').textContent = request.emailSender || '--';
            document.getElementById('email-subject').textContent = request.emailSubject || '--';
            document.getElementById('request-id').textContent = request.requestId || '--';
            document.getElementById('auth-token').textContent = request.authToken || '--';

            // Show cost breakdown
            const attachmentCount = request.attachmentCount || 0;
            const baseCost = 3;
            const attachmentCost = attachmentCount * 2;
            const processingCost = 1;
            const totalCost = request.creditCost || (baseCost + attachmentCost + processingCost);

            document.getElementById('attachment-count').textContent = attachmentCount;
            document.getElementById('attachment-cost').textContent = `${attachmentCost} credits`;
            document.getElementById('total-cost').textContent = `${totalCost} credits`;

            // Show sections
            document.getElementById('email-preview').style.display = 'block';
            document.getElementById('cost-breakdown').style.display = 'block';

            // Check request status
            if (request.status === 'pending') {
                if (userWallet) {
                    showSingleStatus('Ready for authorization.', 'success');
                } else {
                    showSingleStatus('Connect your wallet to authorize this request.', 'warning');
                }
            } else if (request.status === 'authorized') {
                showSingleSuccess('This request has already been authorized.');
                disableAuthorizationButtons();
            } else if (request.status === 'expired') {
                showSingleError('This authorization request has expired.');
                disableAuthorizationButtons();
            } else {
                showSingleStatus(`Request status: ${request.status}`, 'warning');
            }
        }

        // Authorize specific request from pending list
        async function authorizeSpecificRequest(requestId) {
            if (!userWallet) {
                showError('Please connect your wallet first.');
                return;
            }

            try {
                showStatus('Processing authorization...', 'warning');

                // Create signature for the request ID
                const requestIdBytes = requestId;
                const messageHash = ethers.utils.keccak256(ethers.utils.solidityPack(['bytes32'], [requestIdBytes]));
                const signature = await signer.signMessage(ethers.utils.arrayify(messageHash));

                console.log('‚úÖ Signature created for request:', requestId);
                
                const response = await fetch(`${API_BASE}/authorization/authorize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        requestId: requestId,
                        userAddress: userWallet,
                        signature: signature
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const result = await response.json();
                console.log('üì§ Authorization result:', result);

                if (result.success) {
                    showSuccess(`‚úÖ Authorization successful! Email wallet created for request ${requestId}`);
                    // Refresh the pending list
                    setTimeout(() => loadPendingRequests(), 2000);
                } else {
                    throw new Error(result.error || 'Authorization failed');
                }

            } catch (error) {
                console.error('‚ùå Authorization error:', error);
                showError(`Authorization failed: ${error.message}`);
            }
        }

        // Authorize the current request (single view)
        async function authorizeRequest() {
            if (!userWallet || !authorizationRequest) {
                showSingleError('Please connect your wallet first.');
                return;
            }

            try {
                const authorizeBtn = document.getElementById('authorize-btn');
                const authorizeText = document.getElementById('authorize-text');
                
                authorizeBtn.disabled = true;
                authorizeText.innerHTML = '<span class="loading-spinner"></span>Creating signature...';

                showSingleStatus('Creating authorization signature...', 'warning');
                
                const requestIdBytes = authorizationRequest.requestId;
                const messageHash = ethers.utils.keccak256(ethers.utils.solidityPack(['bytes32'], [requestIdBytes]));
                const signature = await signer.signMessage(ethers.utils.arrayify(messageHash));

                console.log('‚úÖ Signature created:', signature);
                
                authorizeText.innerHTML = '<span class="loading-spinner"></span>Submitting authorization...';
                showSingleStatus('Submitting authorization...', 'warning');

                const response = await fetch(`${API_BASE}/authorization/authorize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        requestId: authorizationRequest.requestId,
                        userAddress: userWallet,
                        signature: signature
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const result = await response.json();
                console.log('üì§ Authorization result:', result);

                if (result.success) {
                    const walletId = result.data?.emailWalletId || result.emailWalletId;
                    const txHash = result.data?.authorizationTx || result.authorizationTx;
                    
                    showSingleSuccess(`‚úÖ Authorization successful! Email wallet created.${walletId ? ` Wallet ID: ${walletId}` : ''}${txHash ? ` Transaction: ${txHash}` : ''}`);
                    authorizeText.textContent = 'Authorization Complete ‚úÖ';
                    disableAuthorizationButtons();
                } else {
                    throw new Error(result.error || 'Authorization failed');
                }

            } catch (error) {
                console.error('‚ùå Authorization error:', error);
                showSingleError(`Authorization failed: ${error.message}`);
                
                // Reset button
                const authorizeBtn = document.getElementById('authorize-btn');
                const authorizeText = document.getElementById('authorize-text');
                authorizeBtn.disabled = false;
                authorizeText.textContent = 'Authorize Email Wallet';
            }
        }

        // Reject specific request from pending list
        async function rejectSpecificRequest(requestId) {
            if (confirm('Are you sure you want to reject this email wallet creation?')) {
                try {
                    showStatus('Rejecting request...', 'warning');

                    const response = await fetch(`${API_BASE}/authorization/cancel`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            requestId: requestId
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccess(`Request ${requestId} rejected. No email wallet will be created.`);
                        // Refresh the pending list
                        setTimeout(() => loadPendingRequests(), 2000);
                    } else {
                        throw new Error(result.error || 'Rejection failed');
                    }

                } catch (error) {
                    console.error('‚ùå Rejection error:', error);
                    showError(`Failed to reject request: ${error.message}`);
                }
            }
        }

        // Reject the current request (single view)
        async function rejectRequest() {
            if (!authorizationRequest) {
                showSingleError('No request to reject.');
                return;
            }

            if (confirm('Are you sure you want to reject this email wallet creation?')) {
                try {
                    showSingleStatus('Rejecting request...', 'warning');

                    const response = await fetch(`${API_BASE}/authorization/cancel`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            requestId: authorizationRequest.requestId
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSingleError('Request rejected. No email wallet will be created.');
                        disableAuthorizationButtons();
                    } else {
                        throw new Error(result.error || 'Rejection failed');
                    }

                } catch (error) {
                    console.error('‚ùå Rejection error:', error);
                    showSingleError(`Failed to reject request: ${error.message}`);
                }
            }
        }

        function refreshPendingRequests() {
            loadPendingRequests();
        }

        // Utility functions for pending requests view
        function showStatus(message, type) {
            const container = document.getElementById('status-container');
            container.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        function showSuccess(message) {
            showStatus(message, 'success');
        }

        function showError(message) {
            showStatus(message, 'error');
        }

        // Utility functions for single request view
        function showSingleStatus(message, type) {
            const container = document.getElementById('single-status-container');
            container.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        function showSingleSuccess(message) {
            showSingleStatus(message, 'success');
        }

        function showSingleError(message) {
            showSingleStatus(message, 'error');
        }

        function disableAuthorizationButtons() {
            document.getElementById('authorize-btn').disabled = true;
            document.querySelectorAll('.btn-secondary').forEach(btn => {
                if (btn.textContent.includes('Reject')) {
                    btn.disabled = true;
                }
            });
        }

        // Handle account changes in MetaMask
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    // User disconnected
                    userWallet = null;
                    provider = null;
                    signer = null;
                    updateWalletDisplay();
                } else if (accounts[0] !== userWallet) {
                    // User switched accounts
                    window.location.reload();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                // Reload on network change
                window.location.reload();
            });
        }
    </script>
</body>
</html>