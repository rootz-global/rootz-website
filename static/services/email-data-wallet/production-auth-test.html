<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Email Wallet Authorization Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #2d5016 0%, #4a7c59 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .step {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
        }
        .step.user {
            border-left-color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }
        .step.service {
            border-left-color: #ff9800;
            background: rgba(255, 152, 0, 0.1);
        }
        .step.completed {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        .step.current {
            border-left-color: #e91e63;
            background: rgba(233, 30, 99, 0.1);
        }
        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        button.service-btn {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }
        button.user-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .output {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        .warning { color: #ff9800; }
        .service { color: #ff9800; }
        .user { color: #2196F3; }
        
        .role-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        .role-service {
            background: #ff9800;
            color: white;
        }
        .role-user {
            background: #2196F3;
            color: white;
        }
        
        h1, h2 {
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .workflow-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .api-endpoint {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            margin: 10px 0;
            border-left: 3px solid #4CAF50;
        }
    </style>
</head>
<body>
    <h1>üè≠ Production Email Wallet Authorization Test</h1>
    <p style="text-align: center; font-size: 18px;">
        Realistic workflow: Service backend + User MetaMask signatures
    </p>

    <div class="container">
        <h2>üìã Production Architecture</h2>
        <div class="workflow-info">
            <p><strong>üè¢ Service Backend:</strong> Has private key, creates/processes requests</p>
            <p><strong>üë§ User Frontend:</strong> Has MetaMask, signs authorizations only</p>
            <p><strong>üîó Contract:</strong> 0xcC2a65A8870289B1d33bA741069cC2CEEA219573 (Fixed)</p>
            <p><strong>üì° API Base:</strong> http://rootz.global:5000/api</p>
        </div>
    </div>

    <div class="container">
        <div id="step1" class="step user">
            <h3><span class="role-indicator role-user">USER</span>Step 1: Connect User Wallet</h3>
            <p>Connect the data owner's MetaMask wallet for signing</p>
            <div class="api-endpoint">Required Wallet: 0x107C5655ce50AB9744Fc36A4e9935E30d4923d0b</div>
            <button class="user-btn" onclick="connectUserWallet()">Connect Data Owner Wallet</button>
            <div id="user-wallet-output" class="output" style="display: none;"></div>
        </div>

        <div id="step2" class="step service">
            <h3><span class="role-indicator role-service">SERVICE</span>Step 2: Service Creates Authorization Request</h3>
            <p>Backend service creates authorization request using its private key</p>
            <div class="api-endpoint">POST /api/authorization/create-request</div>
            <button class="service-btn" onclick="serviceCreateRequest()" disabled id="createRequestBtn">Service: Create Request</button>
            <div id="service-request-output" class="output" style="display: none;"></div>
        </div>

        <div id="step3" class="step user">
            <h3><span class="role-indicator role-user">USER</span>Step 3: User Signs Authorization</h3>
            <p>User signs the request ID using MetaMask (no backend needed)</p>
            <button class="user-btn" onclick="userSignAuthorization()" disabled id="signAuthBtn">User: Sign with MetaMask</button>
            <div id="user-sign-output" class="output" style="display: none;"></div>
        </div>

        <div id="step4" class="step service">
            <h3><span class="role-indicator role-service">SERVICE</span>Step 4: Service Submits User Signature</h3>
            <p>Backend service submits the user's signature to authorize wallet creation</p>
            <div class="api-endpoint">POST /api/authorization/submit-signature</div>
            <button class="service-btn" onclick="serviceSubmitSignature()" disabled id="submitSigBtn">Service: Submit Authorization</button>
            <div id="service-submit-output" class="output" style="display: none;"></div>
        </div>

        <div id="step5" class="step service">
            <h3><span class="role-indicator role-service">SERVICE</span>Step 5: Service Processes Email Wallet</h3>
            <p>Backend service processes the authorized request to create the email wallet</p>
            <div class="api-endpoint">POST /api/authorization/process-wallet</div>
            <button class="service-btn" onclick="serviceProcessWallet()" disabled id="processWalletBtn">Service: Create Wallet</button>
            <div id="service-process-output" class="output" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>üîç Test Activity Log</h2>
        <div id="activity-log" class="output"></div>
        <button onclick="clearLog()" style="background: #666;">Clear Log</button>
        <button onclick="exportTestResults()" style="background: #666;">Export Results</button>
    </div>

    <script>
        const CONFIG = {
            apiBase: window.location.origin + '/api',
            expectedDataOwner: '0x107C5655ce50AB9744Fc36A4e9935E30d4923d0b',
            contractAddress: '0xcC2a65A8870289B1d33bA741069cC2CEEA219573'
        };

        let userAccount = null;
        let testData = {
            requestId: '',
            authToken: '',
            userSignature: '',
            emailHash: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef'
        };

        function log(message, type = 'info', actor = '') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#ffffff',
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800',
                service: '#ff9800',
                user: '#2196F3'
            };
            
            const actorPrefix = actor ? `[${actor.toUpperCase()}] ` : '';
            const logContainer = document.getElementById('activity-log');
            logContainer.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${actorPrefix}${message}</span>\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${actorPrefix}${message}`);
        }

        async function connectUserWallet() {
            try {
                if (!window.ethereum) {
                    throw new Error('MetaMask not detected!');
                }

                log('Connecting MetaMask...', 'info', 'USER');
                document.getElementById('step1').classList.add('current');
                
                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Get current account
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                userAccount = accounts[0];
                
                // Check if correct wallet
                const isCorrectWallet = userAccount.toLowerCase() === CONFIG.expectedDataOwner.toLowerCase();
                
                const output = document.getElementById('user-wallet-output');
                output.style.display = 'block';
                output.innerHTML = `
                    <div class="${isCorrectWallet ? 'success' : 'error'}">
                        Connected: ${userAccount}
                        Expected: ${CONFIG.expectedDataOwner}
                        Status: ${isCorrectWallet ? '‚úÖ CORRECT WALLET' : '‚ùå WRONG WALLET'}
                    </div>
                `;
                
                if (isCorrectWallet) {
                    log(`Connected correct wallet: ${userAccount}`, 'success', 'USER');
                    document.getElementById('step1').classList.remove('current');
                    document.getElementById('step1').classList.add('completed');
                    document.getElementById('createRequestBtn').disabled = false;
                } else {
                    log(`Wrong wallet connected. Please switch to: ${CONFIG.expectedDataOwner}`, 'error', 'USER');
                    throw new Error('Wrong wallet connected');
                }
                
            } catch (error) {
                log(`Wallet connection failed: ${error.message}`, 'error', 'USER');
                document.getElementById('step1').classList.add('error');
            }
        }

        async function serviceCreateRequest() {
            try {
                log('Service creating authorization request via API...', 'info', 'SERVICE');
                document.getElementById('step2').classList.add('current');
                
                // Generate test data
                testData.authToken = `auth-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                log(`Creating request for user: ${userAccount}`, 'info', 'SERVICE');
                log(`Auth token: ${testData.authToken}`, 'info', 'SERVICE');
                
                // Call backend API to create authorization request
                const requestData = {
                    userWallet: userAccount,
                    authToken: testData.authToken,
                    emailHash: testData.emailHash,
                    attachmentHashes: []
                };
                
                log('Calling backend API...', 'info', 'SERVICE');
                const response = await fetch(`${CONFIG.apiBase}/authorization/create-request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    // For testing, simulate the service creation
                    log('‚ö†Ô∏è API endpoint not available, simulating service behavior...', 'warning', 'SERVICE');
                    
                    // Simulate successful request creation
                    testData.requestId = `0x${Math.random().toString(16).padStart(64, '0')}`;
                    
                    const simulatedResult = {
                        success: true,
                        requestId: testData.requestId,
                        authToken: testData.authToken,
                        transactionHash: `0x${Math.random().toString(16).padStart(64, '0')}`,
                        note: 'SIMULATED - In production, service would create real blockchain transaction'
                    };
                    
                    const output = document.getElementById('service-request-output');
                    output.style.display = 'block';
                    output.textContent = JSON.stringify(simulatedResult, null, 2);
                    
                    log(`‚úÖ Request created (simulated): ${testData.requestId}`, 'success', 'SERVICE');
                    
                } else {
                    const result = await response.json();
                    testData.requestId = result.requestId;
                    
                    const output = document.getElementById('service-request-output');
                    output.style.display = 'block';
                    output.textContent = JSON.stringify(result, null, 2);
                    
                    log(`‚úÖ Request created: ${testData.requestId}`, 'success', 'SERVICE');
                }
                
                // Update UI
                document.getElementById('step2').classList.remove('current');
                document.getElementById('step2').classList.add('completed');
                document.getElementById('signAuthBtn').disabled = false;
                
            } catch (error) {
                log(`Service request creation failed: ${error.message}`, 'error', 'SERVICE');
                document.getElementById('step2').classList.add('error');
            }
        }

        async function userSignAuthorization() {
            try {
                log('User signing authorization with MetaMask...', 'info', 'USER');
                document.getElementById('step3').classList.add('current');
                
                if (!testData.requestId) {
                    throw new Error('No request ID available');
                }
                
                // Create provider and signer
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                
                // Sign the request ID directly (this is what the fixed contract expects)
                log(`Signing request ID: ${testData.requestId}`, 'info', 'USER');
                const requestIdBytes = ethers.getBytes(testData.requestId);
                testData.userSignature = await signer.signMessage(requestIdBytes);
                
                const signatureResult = {
                    requestId: testData.requestId,
                    signature: testData.userSignature,
                    signer: userAccount,
                    signatureLength: testData.userSignature.length,
                    signedBy: 'MetaMask'
                };
                
                const output = document.getElementById('user-sign-output');
                output.style.display = 'block';
                output.textContent = JSON.stringify(signatureResult, null, 2);
                
                log(`‚úÖ Signature created: ${testData.userSignature.substring(0, 20)}...`, 'success', 'USER');
                
                // Update UI
                document.getElementById('step3').classList.remove('current');
                document.getElementById('step3').classList.add('completed');
                document.getElementById('submitSigBtn').disabled = false;
                
            } catch (error) {
                log(`User signature failed: ${error.message}`, 'error', 'USER');
                document.getElementById('step3').classList.add('error');
            }
        }

        async function serviceSubmitSignature() {
            try {
                log('Service submitting user signature via API...', 'info', 'SERVICE');
                document.getElementById('step4').classList.add('current');
                
                const submitData = {
                    requestId: testData.requestId,
                    signature: testData.userSignature,
                    userAddress: userAccount
                };
                
                log('Calling backend API to submit signature...', 'info', 'SERVICE');
                const response = await fetch(`${CONFIG.apiBase}/authorization/submit-signature`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(submitData)
                });
                
                if (!response.ok) {
                    // For testing, simulate the service submission
                    log('‚ö†Ô∏è API endpoint not available, simulating service behavior...', 'warning', 'SERVICE');
                    
                    const simulatedResult = {
                        success: true,
                        requestId: testData.requestId,
                        authorized: true,
                        transactionHash: `0x${Math.random().toString(16).padStart(64, '0')}`,
                        note: 'SIMULATED - In production, service would submit to blockchain'
                    };
                    
                    const output = document.getElementById('service-submit-output');
                    output.style.display = 'block';
                    output.textContent = JSON.stringify(simulatedResult, null, 2);
                    
                    log(`‚úÖ Authorization submitted (simulated)`, 'success', 'SERVICE');
                    
                } else {
                    const result = await response.json();
                    
                    const output = document.getElementById('service-submit-output');
                    output.style.display = 'block';
                    output.textContent = JSON.stringify(result, null, 2);
                    
                    log(`‚úÖ Authorization submitted successfully`, 'success', 'SERVICE');
                }
                
                // Update UI
                document.getElementById('step4').classList.remove('current');
                document.getElementById('step4').classList.add('completed');
                document.getElementById('processWalletBtn').disabled = false;
                
            } catch (error) {
                log(`Service signature submission failed: ${error.message}`, 'error', 'SERVICE');
                document.getElementById('step4').classList.add('error');
            }
        }

        async function serviceProcessWallet() {
            try {
                log('Service processing email wallet creation...', 'info', 'SERVICE');
                document.getElementById('step5').classList.add('current');
                
                const processData = {
                    requestId: testData.requestId,
                    emailData: {
                        forwardedBy: "production-test",
                        originalSender: userAccount,
                        messageId: `wallet-${Date.now()}`,
                        subject: "Production Authorization Test",
                        bodyHash: testData.emailHash,
                        emailHash: testData.emailHash,
                        emailHeadersHash: testData.emailHash,
                        attachmentCount: 0,
                        ipfsHash: "QmProductionAuthTest2025"
                    },
                    attachmentData: []
                };
                
                log('Calling backend API to process wallet...', 'info', 'SERVICE');
                const response = await fetch(`${CONFIG.apiBase}/authorization/process-wallet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(processData)
                });
                
                if (!response.ok) {
                    // For testing, simulate the wallet creation
                    log('‚ö†Ô∏è API endpoint not available, simulating service behavior...', 'warning', 'SERVICE');
                    
                    const simulatedResult = {
                        success: true,
                        emailWalletId: `0x${Math.random().toString(16).padStart(64, '0')}`,
                        requestId: testData.requestId,
                        transactionHash: `0x${Math.random().toString(16).padStart(64, '0')}`,
                        creditsUsed: 4,
                        note: 'SIMULATED - In production, service would create real blockchain wallet'
                    };
                    
                    const output = document.getElementById('service-process-output');
                    output.style.display = 'block';
                    output.textContent = JSON.stringify(simulatedResult, null, 2);
                    
                    log(`‚úÖ Email wallet created (simulated): ${simulatedResult.emailWalletId}`, 'success', 'SERVICE');
                    log('üéâ COMPLETE EMAIL WALLET WORKFLOW SUCCESSFUL!', 'success', 'SYSTEM');
                    
                } else {
                    const result = await response.json();
                    
                    const output = document.getElementById('service-process-output');
                    output.style.display = 'block';
                    output.textContent = JSON.stringify(result, null, 2);
                    
                    log(`‚úÖ Email wallet created: ${result.emailWalletId}`, 'success', 'SERVICE');
                    log('üéâ COMPLETE EMAIL WALLET WORKFLOW SUCCESSFUL!', 'success', 'SYSTEM');
                }
                
                // Update UI
                document.getElementById('step5').classList.remove('current');
                document.getElementById('step5').classList.add('completed');
                
            } catch (error) {
                log(`Service wallet processing failed: ${error.message}`, 'error', 'SERVICE');
                document.getElementById('step5').classList.add('error');
            }
        }

        function clearLog() {
            document.getElementById('activity-log').innerHTML = '';
            log('Log cleared', 'info', 'SYSTEM');
        }

        function exportTestResults() {
            const results = {
                timestamp: new Date().toISOString(),
                testData: testData,
                userAccount: userAccount,
                log: document.getElementById('activity-log').textContent
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `production-auth-test-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('Test results exported', 'success', 'SYSTEM');
        }

        // Initialize page
        window.addEventListener('load', () => {
            log('Production Email Wallet Authorization Test loaded', 'info', 'SYSTEM');
            log('This simulates the real production workflow:', 'info', 'SYSTEM');
            log('‚Ä¢ Service backend handles blockchain transactions', 'info', 'SYSTEM');
            log('‚Ä¢ User frontend only provides MetaMask signatures', 'info', 'SYSTEM');
            
            if (!window.ethereum) {
                log('‚ùå MetaMask not detected! Please install MetaMask.', 'error', 'USER');
            }
        });
    </script>
</body>
</html>